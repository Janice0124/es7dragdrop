<!-- Started 1/18/2017
	Last edit: 1/25/2017
	Takes an array of JSON objects representing workspace components, turns array into a scheme file,
	and creates a .aia file containing all folders and content text files as 
	would be found in App Inventor .aia file.
	Hard codes folders/subfolders, text file content, and data.
	Folder downloaded is named "Hello.aia"
-->

<html>
<head>
	<!--<script src="/Users/Janice/Documents/AppInventor/Stuk-jszip-5250332/dist/jszip.js"></script>
-->
	<!-- Only needed two files in local folder, instead of entire JSZip folder -->
	<script type="text/javascript" src="jszip.js"></script>
	<script type="text/javascript" src="FileSaver.js"></script>

</head>
 
<body>
	<!-- Click on button to download .aia file -->
	<input type="button" onclick="create_zip()" value="Create Zip File"></input>
<script>

/** 
 * Main function: creates the .aia file
 * Gets the data (hard-coded below) and turns it into stringified JSON object
 * Creates the folder and all subfolders (hard-coded)
 * Adds the text files (with content)into the folders.
 * Then generates the zip file itself and allows user to download it.
 * zip file is saved as "Hello.aia".
 */
function create_zip() {
	var data = get_data();

	var zip = new JSZip();

	var projectPropertiesContent = 'main=appinventor.ai_janicec124.Hello.Screen1\nname=Hello\nassets=../assets\nsource=../src\nbuild=../build\nversioncode=1\nversionname=1.0\nuseslocation=False\naname=Hello\nsizing=Fixed';
	var scmContent = '#|\n$JSON\n' + get_scm(data) + '\n|#';
	var bkyContent = '<xml xmlns="http://www.w3.org/1999/xhtml">\n  <block type="component_event" id="1" x="1" y="1">\n    <mutation component_type="Button" instance_name="Button1" event_name="Click"></mutation>\n    <field name="COMPONENT_SELECTOR">Button1</field>\n  </block>\n  <yacodeblocks ya-version="158" language-version="20"></yacodeblocks>\n</xml>';

	
	var projZip = zip.folder("youngandroidproject");
	projZip.file("project.properties", projectPropertiesContent);
	
	var helloZip = zip.folder("src").folder("appinventor").folder("ai_janicec124").folder("Hello");
	helloZip.file("Screen1.bky", bkyContent);
	helloZip.file("Screen1.scm", scmContent);

	// Works but downloads "Unknown" file - can't change name
	// zip.generateAsync({type:"base64"}).then(function (base64) {
	//     location.href="data:application/zip;base64," + base64;
	// });

	// Doesn't work in Safari - only works in Chrome
	// Can define file name - just change to .zip or .aia
	//
	// Generates the zip and allows it to be saved as .aia file
	zip.generateAsync({type:"blob"})
	.then(function (blob) {
	    saveAs(blob, "Hello.aia");
	});
}

/** 
 * contains several example/test arrays of data (hard-coded) stored as variables
 * change which variable array to return to choose the data that will be in the zip file.
 */
function get_data() {	
	var scrOnly = [{"id":"1", "version": "19", "type":"Form", "Title":"Screen1", "name": "Screen1", "AppName": "Screen"}];
	var scrButtonActual = [
		{
			"type": "Button",
			"version": "6",
			"name": "Button1",
			"Text": "Hello",
			"id": "1216449460"
		},
		{
			"name": "Screen1", 
			"id":"0", 
			"type":"Form", 
			"Title":"Screen1", 
			"version":"19", 
			"AppName":"Hello", 
			"children":["1216449460"]
		}
	]
	var scrButtons = [
		{
			"name": "Button1",
			"type":"Button",
			"id":"-496282275",
			"version":"6",
			"Text":"Text for Button1",
		},
		{
			"name": "Screen1", 
			"type":"Form", 
			"id":"0", 
			"version": "19", 
			"Title":"Screen1", 
			"AppName":"Hello2", 
			"children":["939054039"]
		},
		{
			"name": "HorizontalArrangement1", 
			"type":"HorizontalArrangement", 
			"id":"1961822558", 
			"version": "3", 
			"children":["-496282275", "53776343"]
		},
		{
			"name": "VerticalArrangement1", 
			"type":"VerticalArrangement", 
			"id":"939054039", 
			"version": "3", 
			"children":["1961822558", "-1864349167"]
		},
		{
			"name": "PasswordTextBox1", 
			"type":"PasswordTextBox", 
			"id":"-1864349167", 
			"version": "3", 
		},
		{
			"name": "CheckBox1", 
			"type":"CheckBox", 
			"id":"53776343", 
			"version": "2", 
		}
	]
	return scrButtons;
}

/**
 * Converts the given data array into a JSON object, then 
 * turns the object into a string that will be the body content
 * of the Scheme file.
 */
function get_scm(arr) {
	var obj = convert_to_scm(arr);
	var result = JSON.stringify(obj);
	return result;
}

/**
 * Given the data array of component objects, puts together the content
 * that will be in the Scheme file
 * @return proj (object): JSON object that will be in the Scheme file
 */
function convert_to_scm(arr) {
	allObjs = {}

	// INITIALIZE PROJECT
	proj = {}
	proj["authURL"] = ["ai2.appinventor.mit.edu"];
	proj["YaVersion"] = "158";
	proj["Source"] = "Form";
	proj["Properties"] = {};

	allObjs = create_all_objects(arr);
	console.log(allObjs);

	for (i = 0; i < arr.length; i++) 
	{
		entry = arr[i];
		entryId = entry["id"];
		// console.log(entry, entryId)
		if (entry.hasOwnProperty("children") && entry["children"].length > 0)
		{
			allObjs[entryId]["$Components"] = []
			for (k = 0; k < entry["children"].length; k++)
			{
				childId = entry["children"][k];
				if (!allObjs.hasOwnProperty(childId))
				{
					allObjs[childId] = {};
				}
				allObjs[entryId]["$Components"].push(allObjs[childId])
			}
		}

		if (entry["type"] === "Form")
		{
			proj["Properties"] = allObjs[entryId];
		}
	}
	return proj;
}

/** 
 * Given the data array (of component objects), creates a dictionary
 * of JSON objects that will be used in Scheme file.
 * Dictionary maps the component's unique ID to its JSON object
 */
function create_all_objects(arr) {
	objs = {}
	// FOR EACH ENTRY IN THE ARRAY...
	for (i = 0; i < arr.length; i++)
	{
		// INITIALIZE OBJECT AND COMMON VARIABLES
		entry = arr[i];
		obj = {};
		obj["$Name"] = entry["name"];
		obj["$Type"] = entry["type"];
		obj["$Version"] = entry["version"];
		obj["Uuid"] = entry["id"];
		var id = entry["id"];

		// Add all other properties
		entryProperties = Object.keys(entry);
		for (j = 0; j < entryProperties.length; j++)
		{
			var entryProperty = entryProperties[j];
			if (!special_property(entryProperty))
			{
				obj[entryProperty] = entry[entryProperty];
			}
		}

		objs[id] = obj;
	}
	return objs;
}

/**
 * Checks if the given property is a special property
 * "special" means that the property name in Scheme is different
 * from the property name in the JSON data
 * Ex. "name" in JSON is "$Name" in Scheme
 * @return true if property is special, else false
 */
function special_property(str) {
	properties = ["name", "version", "id", "type", "children"];
	return contains(str, properties);
}

/**
 * Checks if an element is in an array
 * @return true if element is in array, else false
 */
function contains(elmt, arr) {
	for (a = 0; a < arr.length; a++)
	{
		if (arr[a] === elmt) return true;
	}
	return false;
}






</script>
</body>

</html>